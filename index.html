<title>Capstone Dashboard</title>
<script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script src="https://static.robotwebtools.org/keyboardteleopjs/current/keyboardteleop.min.js"></script>
<script src="//yoannmoinet.github.io/nipplejs/javascripts/nipplejs.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>


<script>
  var publishImmidiately = true;
  var robot_IP;
  var manager;
  var ros;

  function emergency_stop() {
    
    var dashboard = new ROSLIB.Topic({
      ros : ros,
      name : "/dashboard",
      messageType : "std_msgs/String"
    });
    var msg = new ROSLIB.Message({
        data : "emergency_stop"
    });
    dashboard.publish(msg);
    console.log("emergency_stop");
    $('.toast_es').toast('show');
  }

  function return_home() {
    var dashboard = new ROSLIB.Topic({
      ros : ros,
      name : "/dashboard",
      messageType : "std_msgs/String"
    });
    var msg = new ROSLIB.Message({
        data : "return_home"
    });
    dashboard.publish(msg);
    console.log("return_home");
    $('.toast_rth').toast('show');
  }

  window.onload = function () {
      // determine robot address automatically
      //robot_IP = location.hostname;
      // set robot address statically
      const urlParams = new URLSearchParams(window.location.search);
      const myParam = urlParams.get('ip');
      if(myParam != null) {
        robot_IP = myParam;
      }
      else {
        robot_IP = "localhost";
      }
      //robot_IP = "192.168.68.126";

      console.log(robot_IP);

      // // Init handle for rosbridge_websocket
      ros = new ROSLIB.Ros({
          url: "ws://" + robot_IP + ":9090"
      });

      var wagon_capacity = new ROSLIB.Topic({
            ros : ros,
            name : '/wagon_capacity',
            messageType : 'std_msgs/Int32'
        });

      wagon_capacity.subscribe(function(message) {
          document.getElementById('capacity').style.width = String(message.data) + "%";
          console.log('Received message on ' + wagon_capacity.name + ': ' + message.data);
      });

      ros.on('close', function() {
          console.log('Connection closed');
          document.getElementById('connecting').style.display = 'none';
          document.getElementById('connected').style.display = 'none';
          document.getElementById('ip').innerHTML = 'To change robot IP, add ?ip={ip} to URL';
          document.getElementById('disconnected').style.display = 'inline';
      });

      ros.on('error', function(error) {
          console.log('Error');
          document.getElementById('connecting').style.display = 'none';
          document.getElementById('connected').style.display = 'none';
          document.getElementById('ip').innerHTML = error;
          document.getElementById('disconnected').style.display = 'inline';
      });

      ros.on('connection', function() {
          console.log('Connection successful!');
          document.getElementById('connecting').style.display = 'none';
          document.getElementById('connected').style.display = 'inline';
          document.getElementById('ip').innerHTML = 'IP: ' + robot_IP;
          document.getElementById('disconnected').style.display = 'none';

            // get handle for video placeholder
          video1 = document.getElementById('video1');
          // Populate video source 
          video1.src = "http://" + robot_IP + ":8080/stream?topic=jetbot_camera";
          video1.onload = function () {
            // onload
          };
          // get handle for video placeholder
          video2 = document.getElementById('video2');
          // Populate video source 
          video2.src = "http://" + robot_IP + ":8080/stream?topic=scan";
      });
  }

  function view_metrics(){
    var wagon_contents = new ROSLIB.Topic({
        ros : ros,
        name : '/wagon_contents',
        messageType : 'std_msgs/String'
    });

    wagon_contents.subscribe(function(message) {
      // Load google charts
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      // Draw the chart and set the chart values
      function drawChart() {
        var data = google.visualization.arrayToDataTable([
        ['Item', 'Quantity'],
        ['Plastic Bottle', 8],
        ['Tissue', 2],
        ['Metal can', 2],
        ['Paper', 2],
        ['Plastic bag', 2],
        ['Others', 8]
        ]);
        
        var options = {
          'title':'All items collected', 
          'width':550, 
          'height':400, 
          'chartArea':{'width':'100%','height':'80%'},
          'backgroundColor': '#111', 
          'titleTextStyle': {'color': 'white', 'fontSize' : 16},
          'legend': {'textStyle': {'color': 'white'}}
        };

        // Display the chart inside the <div> element with id="piechart"
        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(data, options);
      }
      $('.metrics_modal').modal('show')

      console.log('Received message on ' + wagon_contents.name + ': ' + message.data);
    });

    var msg = new ROSLIB.Message({
        data : "request"
    });
    wagon_contents.publish(msg);

  }
</script>

<body style='background-color:#000; position: relative;'>
  <nav class="navbar navbar-expand-md" style="background-color: #000; padding: 10px 20px;">
    <span class="navbar-brand" style="font-size: 2em; padding: 0;">&#x1F916;</span>
      <ul class="navbar-nav mr_auto" style='display: flex; align-items:center;'>
          <div>
              <div>
                <button type="button" class="btn btn-info" id='connecting' disabled>
                    <span class="sr-only">Conencting</span>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </button>
              </div>
              <div>
                <button type="button" class="btn btn-success" id='connected' disabled style='display: none;'>Connected</button>
              </div>
              <div>
                <button type="button" class="btn btn-danger" id='disconnected' disabled data-bs-toggle="tooltip" style='display: none;'>Not Connected</button>
              </div>
          </div>
          <span id='ip' style='color: grey; margin-left: 5px;'>To change robot IP, add ?ip={ip} to URL</span>
      </ul>
  </nav>

  <!--TOAST BOX-->
  <div style="position: absolute; top: 50px; right: 10px; z-index: 999;">
    <div class="toast d-flex align-items-center text-white bg-dark border-0 toast_es" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body">
        Request sent: Emergency Stop
      </div>
      <button type="button" class="btn-close ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast d-flex align-items-center text-white bg-dark border-0 toast_rth" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body">
        Request sent: Return to Home
      </div>
      <button type="button" class="btn-close ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>

  <div style='display: flex; flex-flow: row wrap;'>
    <!-- CAMERA -->
    <div style='width: 50%; position: relative;'>
        <span style='position: absolute; top: 10px; left: 10px;' class='badge bg-info'>CAMERA</span>
        <span style='position: absolute; top: 10px; left: 88px;' class='badge bg-dark'>/camera</span>
        <img src="img/no_signal.png" class="p-1 bg-dark" alt="" id="video1" style='width: 100%;' />
    </div>
    <!-- LIDAR -->
    <div style='width: 50%; position: relative;'>
        <span style='position: absolute; top: 10px; left: 10px;' class='badge bg-info'>LIDAR</span>
        <span style='position: absolute; top: 10px; left: 70px;' class='badge bg-dark'>/scan</span>
        <img src="img/no_signal.png" class="p-1 bg-dark" alt="" id="video2" style='width: 100%;'/>
    </div>
  </div>

  
  <!--Metrics modal-->
  <div class="modal fade metrics_modal" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style='color: white; background-color: #111;'>
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Metrics</h5>
        </div>
        <div class="modal-body">
          <div id='piechart'></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTROL PANEL -->
  <div style='position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: #111; border-radius: 10px; padding: 20px; box-shadow: 0px 0px 50px 10px black;'>
      <span style='color: #666;'>Wagon Capacity</span>
      <div class="progress" style='height: 10px; width: 100%; background-color: #222; margin-bottom: 20px;'>
        <div class="progress-bar bg-info" id='capacity' role="progressbar" style="width: 20%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <button type="button" class="btn btn-outline-success" onclick="emergency_stop()">Resume</button>
      <button type="button" class="btn btn-outline-danger" onclick="emergency_stop()">Emergency Stop</button>
      <button type="button" class="btn btn-outline-warning" onclick="return_home()">Return to Home</button>
      <button type="button" class="btn btn-outline-info" onclick="view_metrics()">View Metrics</button>
  </div>
</div>

</body>
